{% from 'macros.html' import modal, modal_button, exampledata %}
{% extends "layout.html" %}
{% block title %}Database: {{s.title}}{% endblock %}
{% block head %}
    {{ super() }}
{% endblock %}

{% block masthead %}
    <h1 class="title">Warehouse: {{s.title}}</h1>
    <p>UID: {{s.uid}}<br/>DSN: {{s.dsn}}{% if s.url -%}<br/>URL: {{s.url}} {%endif%}</p>
    {% if s.summary -%}<p>{{s.summary}}</p>{% endif -%}
{% endblock %}

{% block body %}
<div class="col-md-12">

    <h2>Collections</h2>
    <p>Collections in this warehouse </p>
    <table  class="table table-hover table-condensed" >
    {% for uid, m in s.manifests.items() -%}
        <tr>
        <td><a href="{{manifest_path(uid)}}">{{uid}}</a></td>
        <td>{{m.title}}</td>
        <td>{{m.summary.html}}</td>
        </tr>
    {% endfor %}
    </table>
</div>

<div class="col-md-12">
    <h2>Tables</h2>
    <table  class="table table-hover table-condensed" >
        <tr>
            <th>id</th>
            <th>Name</th>
            <th>Description</th>
            <th>Installed Names</th>
            <th>Source Collection</th>
            {% if s.url -%}<th>Extracts</th>{% endif -%}
        </tr>
    {% for t in s.tables.values()|selectattr('type','equalto','table') -%}
        {% if t.installed -%}
            <tr>
            <td><a href="{{table_path(t.d_vid, t.vid)}}">{{t.vid}}</a></td>
            <td>{{t.name}}</td>
            <td>{{t.description if t.description  else ''}}</td>
            <td><ul>{% for n in t.installed_names -%}
                <li>{{n}}</li>
                {% endfor -%}</ul>
            </td>
            <td><ul>{% for uid in t.manifests -%}
                {% set m = s.manifests.get(uid) -%}
                <li><a href="{{manifest_path(m.uid)}}">{{m.title}}</a></li>
                {% endfor -%}</ul>
            </td>
            {% if s.url -%}<td>
                {% for format in extractors(t) -%}
                <button type="button">
                <a href="{{extract_url(s.url, t.vid, format)}}">{{format}}</a>
                </button>
                {% endfor -%}
            </td>{% endif %}
            </tr>
        {% endif -%}
    {% endfor %}
    </table>
</div>


<div class="col-md-12">
    <h2>Views and MViews</h2>
    <table  class="table table-hover table-condensed" >
        <tr>
            <th>id</th>
            <th>Name</th>
            <th>Type</th>
            <th>Description</th>
            <th>Source Collection</th>
            <th>Sql</th>
            {% if s.url -%}<th>Extracts</th>{% endif -%}
        </tr>
    {% for t in s.tables.values()|selectattr('type','isin',['view', 'mview']) -%}
        <tr>
        <td>{{t.vid}}</td>
        <td>{{t.name}}</td>
        <td>{{t.type}}</td>
        <td>{{t.description if t.description  else ''}}</td>
        <td><ul>{% for uid in t.manifests -%}
            {% set m = s.manifests.get(uid) -%}
            <li><a href="{{manifest_path(m.uid)}}">{{m.title}}</a></li>
            {% endfor -%}</ul>
        </td>
        <td>
            {{modal_button('sql_source-'+t.vid,'SQL')}}
            {% call modal(id='sql_source-'+t.vid,title='SQL Source for "'+t.name+'"') %}
                <div class="codehilite " >
                    {{t.sql_formatted}}
                </div>

                <div  >
                    {{t.get('doc',{}).html}}
                </div>
            {% endcall %}
        </td>
        {% if s.url -%}<td>
                {% for format in extractors(t) -%}
                <button type="button">
                <a href="{{extract_url(s.url, t.vid, format)}}">{{format}}</a>
                </button>
                {% endfor -%}
        </td>{% endif %}
        </tr>
    {% endfor %}
    </table>
</div>

{% endblock %}